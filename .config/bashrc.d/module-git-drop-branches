#!/usr/bin/env bash
# -*- coding: utf-8 -*-

__git_drop_branches() {
    local current_branch remote default_branch branch

    current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)
    if [[ -z ${current_branch} ]]; then
        echo "error: not on a branch (detached HEAD)" >&2
        return 1
    fi

    remote=$(git config --get "branch.${current_branch}.remote" 2>/dev/null)
    if [[ -z ${remote} ]]; then
        echo "error: current branch has no remote configured" >&2
        return 1
    fi

    default_branch=$(git symbolic-ref "refs/remotes/${remote}/HEAD" 2>/dev/null)
    if [[ -z ${default_branch} ]]; then
        echo "error: cannot determine default branch (try: git remote set-head ${remote} -a)" >&2
        return 1
    fi
    default_branch=${default_branch#"refs/remotes/${remote}/"}

    while IFS= read -r branch; do
        if [[ ${branch} == "${current_branch}" || ${branch} == "${default_branch}" ]]; then
            continue
        fi
        git update-ref -d "refs/heads/${branch}"
        echo "Deleted branch ${branch}"
    done < <(git for-each-ref --format='%(refname:short)' refs/heads)
}
